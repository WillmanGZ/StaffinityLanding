---
import "../../styles/styles.css";
import Layout from "../../layouts/Layout.astro";
import vacancyService from "../../services/vacancyService";
import type { Vacancy } from "../../interfaces/vacancy";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/jobs");
}

let vacancies: Vacancy[] = [];

try {
  vacancies = await vacancyService.getAll();
} catch {
  return Astro.redirect("/jobs");
}

// Find the vacancy by ID
const vacancy = vacancies.find((job) => job.id === id);

if (!vacancy) {
  return Astro.redirect("/jobs");
}

// Format salary range
const formatSalary = (min?: number, max?: number, curr?: string) => {
  if (!min && !max) return null;
  const formatter = new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: curr || "USD",
    maximumFractionDigits: 0,
  });
  if (min && max) return `${formatter.format(min)} - ${formatter.format(max)}`;
  if (min) return `From ${formatter.format(min)}`;
  if (max) return `Up to ${formatter.format(max)}`;
  return null;
};

const salaryDisplay = formatSalary(
  vacancy.salaryMin,
  vacancy.salaryMax,
  vacancy.currency
);
const locationDisplay = vacancy.remoteAllowed
  ? `${vacancy.location} (Remote)`
  : vacancy.location;
---

<Layout
  title={`Apply for ${vacancy.title} - HexaLink`}
  description={`Apply for the ${vacancy.title} position at HexaLink. ${vacancy.description}`}
>
  <main class="apply-page">
    <div class="apply-page-container">
      <div class="apply-page-header">
        <a href="/jobs" class="back-link">‚Üê Back to Job Offers</a>
        <h1>Apply for Position</h1>
      </div>

      <div class="apply-page-content">
        <!-- Vacancy Info Card (Left) -->
        <div class="vacancy-info-card">
          <h2>{vacancy.title}</h2>
          <span class={`vacancy-status status-${vacancy.status.toLowerCase()}`}>
            {vacancy.status}
          </span>

          <div class="vacancy-details">
            <div class="vacancy-detail-item">
              <span class="detail-icon">üìç</span>
              <div class="detail-text">
                <strong>Location</strong>
                <p>{locationDisplay}</p>
              </div>
            </div>

            <div class="vacancy-detail-item">
              <span class="detail-icon">üíº</span>
              <div class="detail-text">
                <strong>Seniority</strong>
                <p>{vacancy.seniority}</p>
              </div>
            </div>

            {
              salaryDisplay && (
                <div class="vacancy-detail-item">
                  <span class="detail-icon">üí∞</span>
                  <div class="detail-text">
                    <strong>Salary Range</strong>
                    <p>{salaryDisplay}</p>
                  </div>
                </div>
              )
            }
          </div>

          <div class="vacancy-description-section">
            <h3>Description</h3>
            <p>{vacancy.description}</p>
          </div>

          {
            vacancy.requirements && (
              <div class="vacancy-requirements-section">
                <h3>Requirements</h3>
                <p>{vacancy.requirements}</p>
              </div>
            )
          }
        </div>

        <!-- Application Form (Right) -->
        <form class="application-form" id="application-form">
          <h2>Submit Your Application</h2>
          <div id="form-message" class="form-message"></div>

          <input type="hidden" id="vacancyId" name="vacancyId" value={id} />

          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input
                type="text"
                id="firstName"
                name="firstName"
                required
                placeholder="John"
              />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input
                type="text"
                id="lastName"
                name="lastName"
                required
                placeholder="Doe"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="john.doe@example.com"
            />
          </div>

          <div class="form-group">
            <label for="phoneNumber">Phone Number</label>
            <input
              type="tel"
              id="phoneNumber"
              name="phoneNumber"
              required
              placeholder="+1234567890"
            />
          </div>

          <div class="form-group">
            <label for="resumeUrl">Resume URL</label>
            <input
              type="url"
              id="resumeUrl"
              name="resumeUrl"
              required
              placeholder="https://example.com/resume.pdf"
            />
            <small class="form-hint"
              >Link to your resume (Google Drive, Dropbox, etc.)</small
            >
          </div>

          <div class="form-group">
            <label for="linkedinUrl">LinkedIn Profile</label>
            <input
              type="url"
              id="linkedinUrl"
              name="linkedinUrl"
              placeholder="https://linkedin.com/in/johndoe"
            />
          </div>

          <div class="form-group">
            <label for="source">How did you hear about us?</label>
            <select id="source" name="source" required>
              <option value="">Select an option...</option>
              <option value="LinkedIn">LinkedIn</option>
              <option value="Indeed">Indeed</option>
              <option value="Glassdoor">Glassdoor</option>
              <option value="Referral">Employee Referral</option>
              <option value="Company Website">Company Website</option>
              <option value="Social Media">Social Media</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <button type="submit" class="btn-primary" id="submit-btn">
            <span class="btn-text">Submit Application</span>
            <span class="btn-loading" style="display: none;">Submitting...</span
            >
          </button>
        </form>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { candidateService } from "../../services/candidateService";

  const form = document.getElementById("application-form") as HTMLFormElement;
  const firstNameInput = document.getElementById(
    "firstName"
  ) as HTMLInputElement;
  const lastNameInput = document.getElementById("lastName") as HTMLInputElement;
  const emailInput = document.getElementById("email") as HTMLInputElement;
  const phoneNumberInput = document.getElementById(
    "phoneNumber"
  ) as HTMLInputElement;
  const resumeUrlInput = document.getElementById(
    "resumeUrl"
  ) as HTMLInputElement;
  const linkedinUrlInput = document.getElementById(
    "linkedinUrl"
  ) as HTMLInputElement;
  const sourceInput = document.getElementById("source") as HTMLSelectElement;

  form?.addEventListener("submit", async (event: Event) => {
    event.preventDefault();

    if (
      !firstNameInput.value ||
      !lastNameInput.value ||
      !emailInput.value ||
      !phoneNumberInput.value ||
      !resumeUrlInput.value ||
      !sourceInput.value
    ) {
      alert("Please fill in all fields");
      return;
    }

    const id = window.location.pathname.split("/").pop();

    candidateService.apply({
      vacancyId: id!,
      firstName: firstNameInput.value,
      lastName: lastNameInput.value,
      email: emailInput.value,
      phoneNumber: phoneNumberInput.value,
      resumeUrl: resumeUrlInput.value,
      linkedinUrl: linkedinUrlInput.value,
      source: sourceInput.value,
      applicationStatus: "APPLIED",
    });

    alert("Thank you for your application! We will contact you soon");
    form.reset();
  });
</script>
