---
import "../styles/styles.css";
import Layout from "../layouts/Layout.astro";
import VacancyCard from "../components/VacancyCard.astro";
import vacancyService from "../services/vacancyService";
import type { Vacancy } from "../interfaces/vacancy";

// Get all vacancies
let vacancies: Vacancy[];

try {
  vacancies = await vacancyService.getAll();
} catch {
  vacancies = [];
}

// Pagination logic
const url = Astro.url;
const currentPage = parseInt(url.searchParams.get("page") || "1");
const jobsPerPage = 10;
const totalPages = Math.ceil(vacancies.length / jobsPerPage);

// Ensure currentPage is within valid range
const validCurrentPage = Math.max(1, Math.min(currentPage, totalPages));

const startIndex = (validCurrentPage - 1) * jobsPerPage;
const endIndex = startIndex + jobsPerPage;
const currentJobs = vacancies.slice(startIndex, endIndex);
---

<Layout
  title="Job Offers - HexaLink"
  description="Explore career opportunities at HexaLink. Join our team and help build the future of human capital management."
>
  <main class="jobs-page">
    <div class="jobs-container">
      <div class="jobs-header">
        <h1>Job Offers</h1>
        <p>Join our team and build the future of human capital management</p>
        <div class="jobs-count">
          <span>{vacancies.length} open positions</span>
        </div>
      </div>

      <div class="jobs-grid">
        {
          currentJobs.map((job) => (
            <VacancyCard
              id={job.id}
              title={job.title}
              description={job.description}
              requirements={job.requirements}
              location={job.location}
              remoteAllowed={job.remoteAllowed}
              seniority={job.seniority}
              status={job.status}
              salaryMin={job.salaryMin}
              salaryMax={job.salaryMax}
              currency={job.currency}
              buttonText="Apply Now"
              buttonHref="/contact"
            />
          ))
        }
      </div>

      <!-- Pagination -->
      {
        totalPages > 1 && (
          <nav class="pagination">
            <a
              href={
                validCurrentPage > 1
                  ? `/jobs?page=${validCurrentPage - 1}`
                  : "#"
              }
              class={`pagination-btn ${validCurrentPage === 1 ? "disabled" : ""}`}
            >
              ← Previous
            </a>

            <div class="pagination-numbers">
              {Array.from({ length: totalPages }, (_, i) => i + 1).map(
                (pageNum) => (
                  <a
                    href={`/jobs?page=${pageNum}`}
                    class={`pagination-number ${pageNum === validCurrentPage ? "active" : ""}`}
                  >
                    {pageNum}
                  </a>
                )
              )}
            </div>

            <a
              href={
                validCurrentPage < totalPages
                  ? `/jobs?page=${validCurrentPage + 1}`
                  : "#"
              }
              class={`pagination-btn ${validCurrentPage === totalPages ? "disabled" : ""}`}
            >
              Next →
            </a>
          </nav>
        )
      }

      <div class="pagination-info">
        Showing {startIndex + 1}-{Math.min(endIndex, vacancies.length)} of {
          vacancies.length
        } positions
      </div>
    </div>
  </main>
</Layout>
